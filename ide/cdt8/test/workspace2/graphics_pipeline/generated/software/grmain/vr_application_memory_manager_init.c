
/**************************************************************************
 *
 * Generated by mcsg
 * Version 1.0.0
 * Build trunk
 * Fri Jul 18 16:04:30 PDT 2008
 * ARC International (c) 2008
 * This is a generated file. All manual edits will be lost.
 *
 **************************************************************************/


#include "vr_application_include.h"

VR_CONST unsigned int vr_n_memory_pools = 2;
void * vr_memory_pool [2] = { 0, 0 };
VR_CONST VrMetaMemoryPool * vr_meta_memory_pool [2] = { 0, 0 };


/* Auxiliary code for memory pool raster_pool_id*/
VrCircularBuffer_raster_pool vr_memory_pool_raster_pool __attribute__ ((section(".raster_pool"), aligned(4)));
char raster_pool_mempool_buffer[ 25344 * 8 ] __attribute__ ((section(".raster_pool"), aligned(4)));

/* Auxiliary code for memory pool grcmd_pool_id*/
VrQueue_VrHWMutexNW grcmd_pool_mempool_header __attribute__ ((section(".grcmd_pool"), aligned(4)));
char grcmd_pool_mempool_buffer[ 128 * 512 ] __attribute__ ((section(".grcmd_pool"), aligned(4)));
void *
vr_memory_pool_get_node (vr_memory_pool_t __vr_mempool_id)
  {
    void * __vr_node = 0;
    #define __vr_mempool_impl ((void *) vr_get_memory_pool_impl (__vr_mempool_id))

    switch (__vr_mempool_id)
      {

      case raster_pool_id:
        do
          {
            int bytes_read;
            VrCircularBuffer_raster_pool* cir_buf = ((VrCircularBuffer_raster_pool *) __vr_mempool_impl);
            VrCircularBufferSync_rp_fixed_size_read (cir_buf, 64, &__vr_node, 4, VrHWMutexNW, 1, 0, bytes_read, bytes_read);
          }
        while (0);
        break;

      case grcmd_pool_id:
        do
          {
            VrStackHWSync_rp_pop ((VrHWNode **) &VrQueue_get_head ((VrQueue_VrHWMutexNW *) __vr_mempool_impl), (VrHWMutexNW *) &VrQueue_get_mutex ((VrQueue_VrHWMutexNW *) __vr_mempool_impl), __vr_node);
          }
        while (0);
        break;
      default:
        vr_set_errno (VR_INVALID_INDEX);
        return 0;
      }

    return (void *) __vr_node;
    #undef __vr_mempool_impl
  }
int 
vr_memory_pool_put_node (vr_memory_pool_t __vr_mempool_id, void * __vr_node)
  {
    #define __vr_mempool_impl ((void *) vr_get_memory_pool_impl (__vr_mempool_id))

    switch (__vr_mempool_id)
      {

      case raster_pool_id:
        do
          {
            int bytes_written;
            VrCircularBuffer_raster_pool* cir_buf = ((VrCircularBuffer_raster_pool *) __vr_mempool_impl);
            VrCircularBufferNoSync_rp_fixed_size_write (cir_buf, 64, &__vr_node, 4, 1, 0, (uint16_t)bytes_written, bytes_written);
          }
        while (0);
        break;

      case grcmd_pool_id:
        do
          {
            VrStackHWSync_push ((VrHWNode **) &VrQueue_get_head ((VrQueue_VrHWMutexNW *) __vr_mempool_impl), (VrHWMutexNW *) &VrQueue_get_mutex ((VrQueue_VrHWMutexNW *) __vr_mempool_impl), __vr_node);
          }
        while (0);
        break;
      default:
        vr_set_errno (VR_INVALID_INDEX);
        return -1;
      }
    return 0;
    #undef __vr_mempool_impl
  }
int
vr_memory_pool_get_id_from_node (vr_memory_pool_t __vr_mempool_id, void * __vr_node)
  {
    int __vr_index = -1;
    #define __vr_mempool_impl ((void *) vr_get_memory_pool_impl (__vr_mempool_id))

    switch (__vr_mempool_id)
      {

      case raster_pool_id:
        do
          {
            __vr_index = (((vr_uint_t) __vr_node - (vr_uint_t)&raster_pool_mempool_buffer) / 25344);
          }
        while (0);
        break;

      case grcmd_pool_id:
        do
          {
            __vr_index = (((vr_uint_t) __vr_node - (vr_uint_t)&grcmd_pool_mempool_buffer) >> 7);
          }
        while (0);
        break;
      default:
        vr_set_errno (VR_INVALID_INDEX);
        return -1;
      }

    return __vr_index;
    #undef __vr_mempool_impl
  }
void *
vr_memory_pool_get_node_from_id (vr_memory_pool_t __vr_mempool_id, int __vr_index)
  {
    void * __vr_node = 0;
    #define __vr_mempool_impl ((void *) vr_get_memory_pool_impl (__vr_mempool_id))

    switch (__vr_mempool_id)
      {

      case raster_pool_id:
        do
          {
            __vr_node = (void *)((vr_uint_t)&raster_pool_mempool_buffer + (__vr_index * 25344));
          }
        while (0);
        break;

      case grcmd_pool_id:
        do
          {
            __vr_node = (void *)((vr_uint_t)&grcmd_pool_mempool_buffer + (__vr_index << 7));
          }
        while (0);
        break;
      default:
        vr_set_errno (VR_INVALID_INDEX);
        return 0;
      }

    return __vr_node;
    #undef __vr_mempool_impl
  }
int
vr_app_memory_manager_init (void)
{
  void * mempool_impl VR_UNUSED_VARIABLE_ATTRIBUTE = 0;

  /* Initialization of meta memory pool structures */
  do
    {
      size_t max_size VR_UNUSED_VARIABLE_ATTRIBUTE = 0;

      max_size = 25344 + vr_get_malloc_byte_alignment_gap_hwarch_SoC_imemory_model(25344);
      if (vr_meta_memory_pool_init (raster_pool_id, "raster_pool_id", hwarch_SoC_imemory_model_membank_id, max_size, 8) < 0)
        {
          vr_set_errno (VR_NOT_ENOUGH_MEMORY);
          return -1;
        }

      max_size = 128 + vr_get_malloc_byte_alignment_gap_hwarch_SoC_imemory_model(128);
      if (vr_meta_memory_pool_init (grcmd_pool_id, "grcmd_pool_id", hwarch_SoC_imemory_model_membank_id, max_size, 512) < 0)
        {
          vr_set_errno (VR_NOT_ENOUGH_MEMORY);
          return -1;
        }
    }
  while (0);

  /* Memory pool initialization */

  do
    {
      int i;
      char * __vr_node;
      VrCircularBuffer_raster_pool* __vr_mempool_impl = &vr_memory_pool_raster_pool;
      do
        {
          int result;
          VrCircularBufferSync_rp_setup ((VrCircularBuffer_raster_pool *) (((char *) (__vr_mempool_impl))), VrHWMutexNW, result);
          if (result < 0)
            {
              vr_set_errno (VR_NOT_ENOUGH_MEMORY);
              return -1;
            }
        }
      while (0);
      __vr_node = &raster_pool_mempool_buffer[0];
      for (i = 0; i < 8; i++)
        {
          int bytes_written;
          VrCircularBuffer_raster_pool* cir_buf = ((VrCircularBuffer_raster_pool *) __vr_mempool_impl);
          VrCircularBufferNoSync_rp_fixed_size_write (cir_buf, 64, &__vr_node, 4, 1, 0, (uint16_t)bytes_written, bytes_written);
          __vr_node += (25344);

        }
      mempool_impl = (void *) __vr_mempool_impl;
    }
    while (0);
  vr_memory_pool [raster_pool_id] = mempool_impl;

  {
    void *hdr = (void *) (&grcmd_pool_mempool_header);
    VrHWNode **head = (VrHWNode **) &VrQueue_get_head ((VrQueue_VrHWMutexNW *) hdr);
    VrHWMutexNW *mutex = (VrHWMutexNW *) &VrQueue_get_mutex ((VrQueue_VrHWMutexNW *) hdr);
    VrStackHWSync_setup (head, mutex);
    mempool_impl = (void *) vr_hw_memory_pool_init (grcmd_pool_id, 128, 512, hdr, (char *)&grcmd_pool_mempool_buffer, head);
    if (!mempool_impl)
      return -1;
  }
  vr_memory_pool [grcmd_pool_id] = mempool_impl;

  return 0;
}
